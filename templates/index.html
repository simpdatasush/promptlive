<!DOCTYPE html>
<html>
<head>
    <title>Lexi Text Concierge</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; justify-content: center; padding: 50px; }
        #chat-container { width: 450px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; }
        #messages { height: 400px; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; border-bottom: 1px solid #eee; }
        .msg { padding: 10px 15px; border-radius: 18px; max-width: 80%; line-height: 1.4; }
        .user { align-self: flex-end; background: #0084ff; color: white; }
        .lexi { align-self: flex-start; background: #e4e6eb; color: black; }
        #input-area { padding: 15px; display: flex; gap: 10px; }
        input { flex: 1; border: 1px solid #ddd; border-radius: 20px; padding: 8px 15px; outline: none; }
    </style>
</head>
<body>
    <div id="chat-container">
        <div id="messages"></div>
        <div id="input-area">
            <input type="text" id="user-input" placeholder="Type to Lexi...">
            <button id="send-btn">Send</button>
        </div>
    </div>

    <script>
        const msgContainer = document.getElementById('messages');
        const input = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        let socket;
        let currentLexiBubble = null;

        function appendMessage(role, text) {
            const div = document.createElement('div');
            div.className = `msg ${role}`;
            div.innerText = text;
            msgContainer.appendChild(div);
            msgContainer.scrollTop = msgContainer.scrollHeight;
            return div;
        }

        function connect() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            socket = new WebSocket(`${protocol}//${window.location.host}/ws/alex-concierge`);
            
            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                
                if (data.text) {
                    if (!currentLexiBubble) {
                        currentLexiBubble = appendMessage('lexi', '');
                    }
                    currentLexiBubble.innerText += data.text;
                    msgContainer.scrollTop = msgContainer.scrollHeight;
                }
                
                if (data.done) {
                    currentLexiBubble = null;
                }
            };
        }

        sendBtn.onclick = () => {
            const text = input.value.trim();
            if (!text) return;
            if (!socket || socket.readyState !== 1) connect();

            const send = () => {
                appendMessage('user', text);
                socket.send(text);
                input.value = '';
            };

            if (socket.readyState === 0) socket.onopen = send;
            else send();
        };
    </script>
</body>
</html>
