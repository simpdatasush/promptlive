<!DOCTYPE html>
<html>
<head>
    <title>Lexi Web</title>
    <style>
        body { background: #000; color: #00fdff; font-family: 'Courier New', monospace; text-align: center; }
        #chat-box { width: 80%; max-width: 600px; height: 400px; margin: 20px auto; border: 1px solid #00fdff; overflow-y: auto; padding: 15px; background: #050505; }
        input { width: 80%; max-width: 600px; background: #111; border: 1px solid #00fdff; color: #00fdff; padding: 15px; font-size: 1.1em; }
        .user-msg { color: #fff; margin: 5px 0; }
        .lexi-msg { color: #00fdff; margin: 5px 0; font-weight: bold; }
    </style>
</head>
<body>
    <h1>LEXI v5 LIVE</h1>
    <div id="chat-box"></div>
    <input type="text" id="userInput" placeholder="Ask Lexi something...">

    <script>
    const chatBox = document.getElementById('chat-box');
    const input = document.getElementById('userInput');
    
    // DYNAMIC PROTOCOL DETECTION
    const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    const socket = new WebSocket(`${protocol}${window.location.host}/ws`);

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 24000 });

    socket.onopen = () => console.log("Connected to Lexi via", protocol);

    socket.onmessage = async (event) => {
        const msg = JSON.parse(event.data);
        if (msg.type === "text") appendChat("Lexi", msg.data, "lexi-msg");
        if (msg.type === "audio") playPCM(msg.data);
    };

    input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && input.value.trim() !== "") {
            socket.send(JSON.stringify({ type: "text", data: input.value }));
            appendChat("You", input.value, "user-msg");
            input.value = "";
        }
    });

    function appendChat(sender, text, className) {
        const div = document.createElement('div');
        div.className = className;
        div.innerText = `${sender}: ${text}`;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function playPCM(base64Data) {
        const arrayBuffer = Uint8Array.from(atob(base64Data), c => c.charCodeAt(0)).buffer;
        const float32Data = new Float32Array(arrayBuffer.byteLength / 2);
        const int16Data = new Int16Array(arrayBuffer);
        for (let i = 0; i < int16Data.length; i++) float32Data[i] = int16Data[i] / 32768.0;
        const buffer = audioCtx.createBuffer(1, float32Data.length, 24000);
        buffer.getChannelData(0).set(float32Data);
        const source = audioCtx.createBufferSource();
        source.buffer = buffer;
        source.connect(audioCtx.destination);
        source.start();
    }
</script>
</body>
</html>
